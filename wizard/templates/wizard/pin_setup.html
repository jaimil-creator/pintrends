{% extends "wizard/project_base.html" %}

{% block title %}Pin Setup - {{ project.name }} | PinTrends{% endblock %}

{% block project_content %}
<div class="max-w-6xl">
    {% if using_session %}
    <div class="mb-8 p-3 bg-green-50 border border-green-200 rounded-xl flex items-center gap-3">
        <i class="bi bi-shield-check text-green-600"></i>
        <div>
            <p class="text-xs text-green-700 font-medium">
                Using existing Pinterest session (<code>auth.json</code>). Automation is ready.
            </p>
        </div>
    </div>
    {% endif %}

    {% if missing_credentials %}
    <div class="mb-8 p-4 bg-yellow-50 border border-yellow-200 rounded-xl flex items-start gap-3">
        <i class="bi bi-exclamation-triangle-fill text-yellow-600 mt-0.5"></i>
        <div>
            <h3 class="text-sm font-bold text-yellow-800">Pinterest Credentials Missing</h3>
            <p class="text-sm text-yellow-700 mt-1">
                To automate posting, please add your Pinterest email and password to your <code>.env</code> file:
            </p>
            <pre class="bg-yellow-100/50 p-3 rounded-lg mt-2 text-xs font-mono text-yellow-800 select-all">PINTEREST_EMAIL=your_email@example.com
PINTEREST_PASSWORD=your_password</pre>
            <p class="text-xs text-yellow-600 mt-2">
                Also ensure you have run <code>playwright install chromium</code> in your terminal if not already
                installed.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Posting Settings -->
    <div class="mb-8 p-6 bg-white border border-gray-100 rounded-2xl shadow-sm">
        <h3 class="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
            <i class="bi bi-sliders"></i> Posting Settings
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Board Selection -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1.5">Pinterest Board Name</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="bi bi-collection text-gray-400"></i>
                    </div>
                    <input type="text" id="board-name-input" placeholder="e.g. Summer Outfits"
                        class="pl-10 w-full px-4 py-2.5 rounded-xl border border-gray-300 focus:border-pinterest-red focus:ring-pinterest-red/20 text-sm placeholder-gray-400 transition-colors">
                </div>
                <p class="text-xs text-gray-400 mt-1.5">Leave empty to use default board from settings.</p>
            </div>

            <!-- Destination Link -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1.5">Destination Link</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="bi bi-link-45deg text-gray-400"></i>
                    </div>
                    <input type="url" id="destination-link-input" placeholder="https://..."
                        value="{{ blog_url|default:'' }}"
                        class="pl-10 w-full px-4 py-2.5 rounded-xl border border-gray-300 focus:border-pinterest-red focus:ring-pinterest-red/20 text-sm placeholder-gray-400 transition-colors">
                </div>
                <p class="text-xs text-gray-400 mt-1.5">This link will be added to all posted pins.</p>
            </div>

            <!-- Schedule Date -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1.5">Schedule Date (Optional)</label>
                <div class="relative">
                    <input type="date" id="schedule-date-input"
                        class="w-full px-4 py-2.5 rounded-xl border border-gray-300 focus:border-pinterest-red focus:ring-pinterest-red/20 text-sm placeholder-gray-400 transition-colors">
                </div>
            </div>

            <!-- Schedule Time -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1.5">Schedule Time (Optional)</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="bi bi-clock text-gray-400"></i>
                    </div>
                    <select id="schedule-time-input"
                        class="pl-10 w-full px-4 py-2.5 rounded-xl border border-gray-300 focus:border-pinterest-red focus:ring-pinterest-red/20 text-sm placeholder-gray-400 transition-colors appearance-none bg-white">
                        <option value="">Post Immediately</option>
                        <option value="12:00 AM">12:00 AM</option>
                        <option value="12:30 AM">12:30 AM</option>
                        <option value="01:00 AM">01:00 AM</option>
                        <option value="01:30 AM">01:30 AM</option>
                        <option value="02:00 AM">02:00 AM</option>
                        <option value="02:30 AM">02:30 AM</option>
                        <option value="03:00 AM">03:00 AM</option>
                        <option value="03:30 AM">03:30 AM</option>
                        <option value="04:00 AM">04:00 AM</option>
                        <option value="04:30 AM">04:30 AM</option>
                        <option value="05:00 AM">05:00 AM</option>
                        <option value="05:30 AM">05:30 AM</option>
                        <option value="06:00 AM">06:00 AM</option>
                        <option value="06:30 AM">06:30 AM</option>
                        <option value="07:00 AM">07:00 AM</option>
                        <option value="07:30 AM">07:30 AM</option>
                        <option value="08:00 AM">08:00 AM</option>
                        <option value="08:30 AM">08:30 AM</option>
                        <option value="09:00 AM">09:00 AM</option>
                        <option value="09:30 AM">09:30 AM</option>
                        <option value="10:00 AM">10:00 AM</option>
                        <option value="10:30 AM">10:30 AM</option>
                        <option value="11:00 AM">11:00 AM</option>
                        <option value="11:30 AM">11:30 AM</option>
                        <option value="12:00 PM">12:00 PM</option>
                        <option value="12:30 PM">12:30 PM</option>
                        <option value="01:00 PM">01:00 PM</option>
                        <option value="01:30 PM">01:30 PM</option>
                        <option value="02:00 PM">02:00 PM</option>
                        <option value="02:30 PM">02:30 PM</option>
                        <option value="03:00 PM">03:00 PM</option>
                        <option value="03:30 PM">03:30 PM</option>
                        <option value="04:00 PM">04:00 PM</option>
                        <option value="04:30 PM">04:30 PM</option>
                        <option value="05:00 PM">05:00 PM</option>
                        <option value="05:30 PM">05:30 PM</option>
                        <option value="06:00 PM">06:00 PM</option>
                        <option value="06:30 PM">06:30 PM</option>
                        <option value="07:00 PM">07:00 PM</option>
                        <option value="07:30 PM">07:30 PM</option>
                        <option value="08:00 PM">08:00 PM</option>
                        <option value="08:30 PM">08:30 PM</option>
                        <option value="09:00 PM">09:00 PM</option>
                        <option value="09:30 PM">09:30 PM</option>
                        <option value="10:00 PM">10:00 PM</option>
                        <option value="10:30 PM">10:30 PM</option>
                        <option value="11:00 PM">11:00 PM</option>
                        <option value="11:30 PM">11:30 PM</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Pin Setup</h1>
            <p class="text-sm text-gray-400 mt-1">Generate images and post pins for <span
                    class="font-semibold text-gray-600">{{ project.name }}</span></p>
        </div>
        <div class="flex items-center gap-3">
            <button id="post-pinterest-btn" onclick="postSelectedToPinterest()"
                class="inline-flex items-center gap-2 px-5 py-2.5 bg-pinterest-red text-white text-sm font-semibold rounded-full hover:bg-[#ad081b] transition-all shadow-sm disabled:opacity-40 disabled:cursor-not-allowed"
                disabled>
                <i class="bi bi-send"></i>
                Post to Pinterest
            </button>
        </div>
    </div>

    {% if pin_ideas %}
    <!-- Select All Bar -->
    <div class="flex items-center gap-4 mb-5 px-4 py-3 bg-gray-50 rounded-2xl">
        <label class="flex items-center gap-2 cursor-pointer select-none">
            <input type="checkbox" id="select-all-pins" onchange="toggleSelectAll(this)"
                class="w-4 h-4 rounded border-gray-300 text-pinterest-red focus:ring-pinterest-red/30">
            <span class="text-sm font-medium text-gray-600">Select All</span>
        </label>
        <span class="text-xs text-gray-400" id="selection-info">{{ pin_ideas|length }} pin ideas available</span>
    </div>

    <!-- Pin Ideas List -->
    <!-- Pin Ideas List -->
    <div id="pin-ideas-container" class="space-y-3">
        {% for pin in pin_ideas %}
        <div class="pin-card group bg-white border border-gray-100 rounded-2xl p-4 hover:shadow-md hover:border-gray-200 transition-all duration-300 relative cursor-pointer"
            onclick="togglePinSelection(this, '{{ pin.id }}')" data-pin-id="{{ pin.id }}">

            <!-- Selection Toggle (Top Right) -->
            <button type="button"
                class="absolute top-4 right-4 z-10 w-8 h-8 flex items-center justify-center rounded-full transition-all duration-200 bg-gray-100 text-gray-400 hover:bg-gray-200 selection-toggle"
                data-selected="false">
                <i class="bi bi-plus-lg text-lg icon-plus"></i>
                <i class="bi bi-check-lg text-lg icon-check hidden"></i>
            </button>

            <!-- Hidden Checkbox for Form Submission -->
            <input type="checkbox" name="selected_pins" value="{{ pin.id }}" class="hidden pin-checkbox">

            <div class="flex items-start gap-4">
                <!-- Image Preview (choose/upload) -->
                <div id="pin-image-{{ pin.id }}" class="shrink-0">
                    {% include "wizard/partials/pin_image_preview.html" with pin=pin %}
                </div>

                <!-- Content -->
                <div class="flex-1 min-w-0 pr-10"> <!-- Added padding right to avoid overlap with toggle -->
                    <div class="flex items-start justify-between gap-3 mb-1">
                        <h3 class="text-sm font-bold text-gray-900 leading-snug line-clamp-2">{{ pin.title }}</h3>
                    </div>

                    <div class="flex items-center gap-2 shrink-0 mb-2">
                        {% if pin.is_posted %}
                        <span
                            class="inline-flex items-center gap-1 px-2.5 py-1 bg-green-50 text-green-600 text-xs font-semibold rounded-full">
                            <i class="bi bi-check-circle-fill text-[10px]"></i> Posted
                        </span>
                        {% elif pin.status == 'scheduled' %}
                        <span
                            class="inline-flex items-center gap-1 px-2.5 py-1 bg-purple-50 text-purple-600 text-xs font-semibold rounded-full">
                            <i class="bi bi-calendar-check text-[10px]"></i> Scheduled
                        </span>
                        {% elif pin.has_image %}
                        <span
                            class="inline-flex items-center gap-1 px-2.5 py-1 bg-blue-50 text-blue-600 text-xs font-semibold rounded-full">
                            <i class="bi bi-image-fill text-[10px]"></i> Image Ready
                        </span>
                        {% else %}
                        <span
                            class="inline-flex items-center gap-1 px-2.5 py-1 bg-gray-50 text-gray-400 text-xs font-semibold rounded-full">
                            <i class="bi bi-clock text-[10px]"></i> No Image
                        </span>
                        {% endif %}
                    </div>

                    {% if pin.description %}
                    <p class="text-xs text-gray-400 mt-1.5 line-clamp-2 leading-relaxed">{{ pin.description }}</p>
                    {% endif %}
                    <div class="flex items-center gap-3 mt-2.5 text-xs text-gray-300">
                        <span><i class="bi bi-tag mr-1"></i>{{ pin.expanded_keyword.keyword|truncatewords:3 }}</span>
                        {% if pin.posted_at %}
                        <span><i class="bi bi-calendar-check mr-1"></i>Posted {{ pin.posted_at|date:"M d" }}</span>
                        {% elif pin.scheduled_at %}
                        <span class="text-purple-400"><i class="bi bi-clock-history mr-1"></i>Scheduled: {{
                            pin.scheduled_at|date:"M d, H:i" }}</span>
                        {% endif %}
                    </div>

                    <!-- Tagged Topics Input -->
                    <div class="mt-3 pt-3 border-t border-gray-50">
                        <label
                            class="block text-[10px] font-semibold text-gray-500 uppercase tracking-wider mb-1">Tagged
                            Topics</label>
                        <input type="text"
                            class="tags-input w-full bg-gray-50 border-gray-100 rounded-lg text-xs px-3 py-2 text-gray-700 placeholder-gray-400 focus:bg-white focus:border-pinterest-red focus:ring-pinterest-red/20 transition-all"
                            placeholder="e.g. fashion, summer outfits (comma separated)"
                            onclick="event.stopPropagation()">
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    <!-- ... (Pagination code if exists) ... -->

</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white rounded-3xl p-8 shadow-2xl max-w-sm w-full mx-4 text-center">
        <div class="w-14 h-14 mx-auto mb-4 rounded-full border-4 border-gray-200 border-t-pinterest-red animate-spin">
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-1" id="loading-title">Generating...</h3>
        <p class="text-sm text-gray-500" id="loading-message">Please wait...</p>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast-container" class="fixed bottom-6 left-6 z-50 flex flex-col gap-2 pointer-events-none">
    <!-- Toasts will be injected here -->
</div>



{% else %}
<!-- Empty State -->
<div class="text-center py-20 bg-gray-50/50 rounded-3xl border border-dashed border-gray-200">
    <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-white shadow-sm flex items-center justify-center">
        <i class="bi bi-pin-angle text-3xl text-gray-300"></i>
    </div>
    <h3 class="text-lg font-bold text-gray-700 mb-2">No Pin Ideas Yet</h3>
    <p class="text-sm text-gray-400 mb-6 max-w-sm mx-auto">Generate content first to create pin ideas for this
        project.</p>
    <a href="{% url 'wizard:content_gen' project.id %}"
        class="inline-flex items-center gap-2 px-6 py-3 bg-pinterest-red text-white text-sm font-semibold rounded-full hover:bg-[#ad081b] transition-colors shadow-sm">
        <i class="bi bi-pencil-square"></i>
        Generate Content
    </a>
</div>
{% endif %}
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white rounded-3xl p-8 shadow-2xl max-w-sm w-full mx-4 text-center">
        <div class="w-14 h-14 mx-auto mb-4 rounded-full border-4 border-gray-200 border-t-pinterest-red animate-spin">
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-1" id="loading-title">Generating...</h3>
        <p class="text-sm text-gray-500" id="loading-message">Please wait...</p>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast-container" class="fixed bottom-6 left-6 z-50 flex flex-col gap-2 pointer-events-none">
    <!-- Toasts will be injected here -->
</div>

<!-- Image Selection Modal -->
<div id="image-modal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[100] hidden items-center justify-center p-4">
    <div
        class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
        <div class="p-8 pb-4 flex items-center justify-between border-b border-gray-50">
            <div>
                <h3 class="text-xl font-bold text-gray-900">Choose Pin Image</h3>
                <p class="text-sm text-gray-500 mt-1">Select from blog images or upload your own</p>
            </div>
            <button onclick="closeImageModal()"
                class="w-10 h-10 rounded-full bg-gray-50 text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition-all">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <div id="gallery-container" class="min-h-[300px]">
            <!-- Content loaded via HTMX -->
            <div class="flex items-center justify-center py-20">
                <div class="w-10 h-10 rounded-full border-4 border-gray-100 border-t-pinterest-red animate-spin"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPinId = null;

    function openImageModal(pinId, event) {
        if (event) event.stopPropagation();
        currentPinId = pinId;
        const modal = document.getElementById('image-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Load gallery via HTMX-like fetch
        const galleryContainer = document.getElementById('gallery-container');
        fetch(`{% url 'wizard:get_project_images_htmx' project.id %}`)
            .then(res => res.text())
            .then(html => {
                galleryContainer.innerHTML = html;
            });
    }

    function closeImageModal() {
        const modal = document.getElementById('image-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        currentPinId = null;
    }

    function selectGalleryImage(url) {
        if (!currentPinId) return;

        const pinImageContainer = document.getElementById(`pin-image-${currentPinId}`);
        const formData = new FormData();
        formData.append('image_url', url);

        fetch(`/pin/${currentPinId}/update-image/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(res => res.text())
            .then(html => {
                pinImageContainer.innerHTML = html;
                closeImageModal();
                showToast('Pin image updated!', 'success');
            });
    }

    function handleCustomUpload(input) {
        if (!currentPinId || !input.files[0]) return;

        const pinImageContainer = document.getElementById(`pin-image-${currentPinId}`);
        const formData = new FormData();
        formData.append('custom_image', input.files[0]);

        // Show loading in gallery
        document.getElementById('gallery-grid').classList.add('opacity-40', 'pointer-events-none');

        fetch(`/pin/${currentPinId}/update-image/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(res => res.text())
            .then(html => {
                pinImageContainer.innerHTML = html;
                closeImageModal();
                showToast('Custom image uploaded!', 'success');
            });
    }

    function togglePinSelection(card, pinId) {
        const checkbox = card.querySelector('.pin-checkbox');
        const toggleBtn = card.querySelector('.selection-toggle');
        const iconPlus = toggleBtn.querySelector('.icon-plus');
        const iconCheck = toggleBtn.querySelector('.icon-check');

        // Toggle state
        const isSelected = !checkbox.checked;
        checkbox.checked = isSelected;

        // Update UI
        if (isSelected) {
            // Card Style
            card.classList.remove('border-gray-100');
            card.classList.add('border-green-500', 'bg-green-50/10'); // Slight green tint if desired

            // Button Style
            toggleBtn.classList.remove('bg-gray-100', 'text-gray-400', 'hover:bg-gray-200');
            toggleBtn.classList.add('bg-green-500', 'text-white', 'shadow-md', 'hover:bg-green-600');

            // Icon
            iconPlus.classList.add('hidden');
            iconCheck.classList.remove('hidden');
        } else {
            // Card Style
            card.classList.add('border-gray-100');
            card.classList.remove('border-green-500', 'bg-green-50/10');

            // Button Style
            toggleBtn.classList.add('bg-gray-100', 'text-gray-400', 'hover:bg-gray-200');
            toggleBtn.classList.remove('bg-green-500', 'text-white', 'shadow-md', 'hover:bg-green-600');

            // Icon
            iconPlus.classList.remove('hidden');
            iconCheck.classList.add('hidden');
        }

        updateSelection();
    }

    function getSelectedPinIds() {
        const checked = document.querySelectorAll('.pin-checkbox:checked');
        return Array.from(checked).map(cb => cb.value);
    }

    function updateSelection() {
        const ids = getSelectedPinIds();
        const count = ids.length;
        const postBtn = document.getElementById('post-pinterest-btn');
        const scheduleBtn = document.getElementById('schedule-btn');
        const infoEl = document.getElementById('selection-info');

        if (postBtn) postBtn.disabled = count === 0;
        if (scheduleBtn) scheduleBtn.disabled = count === 0;

        if (infoEl) {
            infoEl.textContent = count > 0
                ? `${count} pin${count > 1 ? 's' : ''} selected`
                : '{{ pin_ideas|length }} pin ideas available';
        }
    }

    function toggleSelectAll(checkbox) {
        document.querySelectorAll('.pin-checkbox').forEach(cb => {
            cb.checked = checkbox.checked;
        });
        updateSelection();
    }

    function showLoading(title, message) {
        const overlay = document.getElementById('loading-overlay');
        document.getElementById('loading-title').textContent = title;
        document.getElementById('loading-message').textContent = message;
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
    }

    function hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        overlay.classList.remove('flex');
        overlay.classList.add('hidden');
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');

        // Colors based on type
        const bgClass = type === 'success' ? 'bg-gray-900' : 'bg-red-500';
        const icon = type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill';

        toast.className = `${bgClass} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 transform translate-y-10 opacity-0 transition-all duration-300 pointer-events-auto min-w-[300px]`;
        toast.innerHTML = `
                <i class="bi ${icon} text-lg"></i>
                <span class="text-sm font-medium">${message}</span>
            `;

        container.appendChild(toast);

        // Animate in
        requestAnimationFrame(() => {
            toast.classList.remove('translate-y-10', 'opacity-0');
        });

        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('translate-y-10', 'opacity-0');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }



    function generateSelectedImages() {
        const ids = getSelectedPinIds();
        if (ids.length === 0) return;

        showLoading('Generating Pin Images', `Creating images for ${ids.length} pin${ids.length > 1 ? 's' : ''}...`);

        fetch("{% url 'wizard:generate_pin_images' project.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ pin_ids: ids })
        })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showToast('Images generated successfully!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                hideLoading();
                showToast('Network error: ' + err.message, 'error');
            });
    }

    function postSelectedToPinterest() {
        const ids = getSelectedPinIds();
        if (ids.length === 0) return;

        // Check if all selected pins have images
        const pinsWithoutImages = [];
        ids.forEach(id => {
            const card = document.querySelector(`[data-pin-id="${id}"]`);
            if (card && !card.querySelector('img')) {
                pinsWithoutImages.push(id);
            }
        });

        if (pinsWithoutImages.length > 0) {
            showToast('Some selected pins do not have images. Please select images for each pin first.', 'error');
            return;
        }

        // Get custom settings
        const boardName = document.getElementById('board-name-input').value.trim();
        const link = document.getElementById('destination-link-input').value.trim();
        const scheduleDate = document.getElementById('schedule-date-input').value.trim();
        const scheduleTime = document.getElementById('schedule-time-input').value.trim();

        const isScheduling = scheduleDate || scheduleTime;

        if (isScheduling && (!scheduleDate || !scheduleTime)) {
            showToast('Please select BOTH date and time for scheduling, or leave both empty to post immediately.', 'error');
            return;
        }

        const actionText = isScheduling ? 'Scheduling Post' : 'Posting to Pinterest';
        const waitingText = isScheduling ? 'Scheduling on Pinterest...' : 'Posting...';

        showLoading(actionText, waitingText);

        // Collect pin data including tags
        const selectedPinsData = ids.map(id => {
            const card = document.querySelector(`[data-pin-id="${id}"]`);
            const tagInput = card.querySelector('.tags-input');
            const tags = tagInput ? tagInput.value.trim() : '';
            return {
                id: id,
                tags: tags
            };
        });

        const bodyData = { pins_data: selectedPinsData };

        if (boardName) bodyData.board_name = boardName;
        if (link) bodyData.link = link;

        if (isScheduling) {
            bodyData.schedule_date = scheduleDate;
            bodyData.schedule_time = scheduleTime;
        }

        fetch("{% url 'wizard:post_pins_pinterest' project.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(bodyData)
        })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    if (data.results && data.results.length > 0) {
                        let msg = isScheduling ? `Successfully scheduled ${data.posted} pins on Pinterest.` : `Successfully published ${data.posted} pins.`;
                        showToast(msg, 'success');

                        // Dynamically update UI for each result without reloading
                        data.results.forEach(result => {
                            if (result.status === 'success') {
                                const card = document.querySelector(`[data-pin-id="${result.id}"]`);
                                const checkbox = card ? card.querySelector('.pin-checkbox') : null;

                                if (card && checkbox) {
                                    // 1. Deselect (updates UI) if it was selected
                                    if (checkbox.checked) {
                                        // We manually trigger the toggle to unselect it
                                        togglePinSelection(card, result.id);
                                    }

                                    // 2. Update Status Badge
                                    const badgeContainer = card.querySelector('.flex.items-center.gap-2.shrink-0.mb-2');
                                    if (badgeContainer) {
                                        let newBadgeHtml = '';
                                        if (isScheduling) {
                                            newBadgeHtml = `<span class="inline-flex items-center gap-1 px-2.5 py-1 bg-purple-50 text-purple-600 text-xs font-semibold rounded-full"><i class="bi bi-calendar-check text-[10px]"></i> Scheduled</span>`;
                                        } else {
                                            newBadgeHtml = `<span class="inline-flex items-center gap-1 px-2.5 py-1 bg-green-50 text-green-600 text-xs font-semibold rounded-full"><i class="bi bi-check-circle-fill text-[10px]"></i> Posted</span>`;
                                        }
                                        badgeContainer.innerHTML = newBadgeHtml;
                                    }

                                    // 3. Mark as "done" visually
                                    card.classList.add('opacity-60'); // Dim the card to indicate completion
                                }
                            }
                        });

                        // Re-enable/disable buttons based on remaining selection
                        updateSelection();
                    }
                    // Page reload removed to preserve settings
                } else {
                    showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                hideLoading();
                showToast('Network error: ' + err.message, 'error');
            });
    }

    // Dynamic Time Filtering
    function filterScheduleTimes() {
        const dateInput = document.getElementById('schedule-date-input');
        const timeSelect = document.getElementById('schedule-time-input');

        if (!dateInput || !timeSelect) return;

        const selectedDateStr = dateInput.value;
        if (!selectedDateStr) {
            // No date selected, show all
            Array.from(timeSelect.options).forEach(opt => {
                opt.hidden = false;
                opt.disabled = false;
            });
            return;
        }

        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;

        if (selectedDateStr === todayStr) {
            // Is Today - filter past times
            const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();

            Array.from(timeSelect.options).forEach(opt => {
                const val = opt.value;
                if (!val) return; // Skip "Post Immediately" or empty

                // Parse "12:30 PM"
                const [time, period] = val.split(' ');
                let [hours, minutes] = time.split(':').map(Number);

                if (period === 'PM' && hours !== 12) hours += 12;
                if (period === 'AM' && hours === 12) hours = 0;

                const optTotalMinutes = hours * 60 + minutes;

                // Hide if time is in the past (adding 15 min buffer)
                if (optTotalMinutes < currentTotalMinutes + 15) {
                    opt.hidden = true;
                    opt.disabled = true;
                } else {
                    opt.hidden = false;
                    opt.disabled = false;
                    opt.textContent = val;
                }
            });
        } else {
            // Future date - enable all
            Array.from(timeSelect.options).forEach(opt => {
                opt.hidden = false;
                opt.disabled = false;
                if (opt.value) opt.textContent = opt.value;
            });
        }
    }

    // Event Listeners for Date Input
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('schedule-date-input');
        if (dateInput) {
            dateInput.addEventListener('change', filterScheduleTimes);
            dateInput.addEventListener('input', filterScheduleTimes);
            // Also run on load in case date is pre-filled
            filterScheduleTimes();
        }
    });
</script>
{% endblock %}