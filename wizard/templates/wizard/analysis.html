{% extends 'wizard/base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8 h-[calc(100vh-80px)]">
    <div class="flex flex-col lg:flex-row gap-8 h-full">

        <!-- Sidebar: Project Selection & Keywords -->
        <div class="w-full lg:w-1/4 flex flex-col gap-6 h-full">
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100 flex flex-col h-full">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Projects</h2>

                <!-- Project Dropdown -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Project</label>
                    <select
                        class="w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-xl focus:ring-pinterest-red focus:border-pinterest-red block p-3"
                        name="project" hx-get="{% url 'wizard:project_keywords_htmx' %}" hx-target="#keyword-list"
                        hx-indicator="#keywords-loading">
                        <option value="" selected disabled>Choose a project...</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Keywords List -->
                <div class="flex-1 overflow-hidden flex flex-col">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Keywords</h3>

                    <!-- Loading State for Keywords -->
                    <div id="keywords-loading" class="htmx-indicator flex justify-center py-4">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-pinterest-red"></div>
                    </div>

                    <div id="keyword-list" class="flex-1 overflow-y-auto pr-1">
                        <!-- Keywords will be loaded here -->
                        <p class="text-gray-400 text-sm italic text-center py-4">Select a project to see keywords</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content: Graph & Analysis -->
        <div class="w-full lg:w-3/4 flex flex-col h-full overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-sm p-8 border border-gray-100 min-h-full">

                <!-- Manual Search Header -->
                <div class="flex justify-between items-center mb-8 border-b border-gray-100 pb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Trend Analysis</h1>
                        <p class="text-gray-500 mt-1">Select a project keyword or search manually</p>
                    </div>

                    <form hx-get="{% url 'wizard:analysis_fetch' %}" hx-target="#analysis-results"
                        hx-indicator="#loading-indicator" class="flex gap-2 w-full max-w-md">
                        <input type="text" name="keyword" placeholder="Search any keyword..."
                            class="w-full px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-pinterest-red focus:border-pinterest-red outline-none transition-all text-sm">
                        <button type="submit"
                            class="px-6 py-2 bg-pinterest-red text-white font-semibold rounded-xl hover:bg-[#ad081b] transition-colors flex items-center gap-2 whitespace-nowrap">
                            <i class="bi bi-search"></i>
                        </button>
                    </form>
                </div>

                <!-- Loading State -->
                <div id="loading-indicator" class="htmx-indicator flex flex-col items-center justify-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pinterest-red mb-4"></div>
                    <p class="text-gray-500">Fetching trend data...</p>
                </div>

                <!-- Results Container -->
                <div id="analysis-results" class="w-full">
                    <!-- Graph will appear here -->
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <i class="bi bi-graph-up-arrow text-6xl mb-4 text-gray-200"></i>
                        <p>Select a keyword to view insights</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js Annotation Plugin -->
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>

<script>
    // Global function to render chart (called by HTMX response)
    function renderpredictionChart(labels, historyData, predictionData, upperBounds, lowerBounds, separationIndex) {
        const ctx = document.getElementById('predictionChart').getContext('2d');

        // Destroy existing chart if it exists
        if (window.myPredictionChart) {
            window.myPredictionChart.destroy();
        }

        window.myPredictionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Historical',
                        data: historyData,
                        borderColor: '#2563eb', // Blue
                        backgroundColor: '#2563eb',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: false,
                        tension: 0.1,
                        spanGaps: false,
                        order: 2
                    },
                    {
                        label: 'Prediction',
                        data: predictionData,
                        borderColor: '#2563eb', // Blue
                        backgroundColor: '#2563eb',
                        borderWidth: 2,
                        borderDash: [4, 4],
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: false,
                        tension: 0.1,
                        spanGaps: false,
                        order: 3
                    },
                    {
                        label: 'Upper Bound',
                        data: upperBounds,
                        borderColor: 'rgba(37, 99, 235, 0.4)',
                        backgroundColor: 'rgba(37, 99, 235, 0.08)',
                        borderWidth: 1.5,
                        borderDash: [3, 3],
                        pointRadius: 0,
                        pointHoverRadius: 3,
                        fill: '+1',
                        tension: 0.1,
                        spanGaps: false,
                        order: 4
                    },
                    {
                        label: 'Lower Bound',
                        data: lowerBounds,
                        borderColor: 'rgba(37, 99, 235, 0.4)',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        borderDash: [3, 3],
                        pointRadius: 0,
                        pointHoverRadius: 3,
                        fill: false,
                        tension: 0.1,
                        spanGaps: false,
                        order: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        align: 'start',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 8,
                            font: {
                                family: 'Inter',
                                size: 12
                            },
                            filter: function (item, chart) {
                                return !item.text.includes('Lower Bound') && !item.text.includes('Upper Bound');
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#1f2937',
                        bodyColor: '#1f2937',
                        borderColor: '#e5e7eb',
                        borderWidth: 1,
                        titleFont: { family: 'Inter', size: 13, weight: '600' },
                        bodyFont: { family: 'Inter', size: 12 },
                        padding: 12,
                        cornerRadius: 8,
                        filter: function (item) {
                            return item.dataset.label !== 'Lower Bound' && item.dataset.label !== 'Upper Bound';
                        }
                    },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                xMin: separationIndex,
                                xMax: separationIndex,
                                borderColor: 'black',
                                borderWidth: 1,
                                borderDash: [],
                                label: {
                                    display: false
                                }
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: '#f3f4f6',
                            drawBorder: false
                        },
                        ticks: {
                            font: { family: 'Inter', size: 11 },
                            color: '#6b7280',
                            padding: 10
                        },
                        border: { display: false }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: true,
                            color: '#e5e7eb'
                        },
                        ticks: {
                            font: { family: 'Inter', size: 11 },
                            color: '#6b7280',
                            maxTicksLimit: 6,
                            maxRotation: 0
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }
</script>


<style>
    /* Fix for loader taking up space when hidden */
    #loading-indicator,
    #keywords-loading {
        display: none;
    }

    .htmx-request#loading-indicator,
    .htmx-request#keywords-loading {
        display: flex;
    }
</style>

{% endblock %}